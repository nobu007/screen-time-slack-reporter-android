# PR-005: 追加テストファイル作成（カバレッジ70%達成）

**優先度**: High  
**カテゴリ**: Quality  
**関連Gap**: GAP-002, GAP-006  
**関連Issue**: ISS-001  

## 問題

テストファイルが2個（CoreFunctionVerificationTest, SlackWebhookValidatorTest）のみで、70%カバレッジ達成が困難。
主要ロジック（ViewModel, UseCase, Repository）が未検証。

**根拠**:
- `execution/feedback_to_auditor.yml:ISS-NEW-004`
- JaCoCo設定は完了したが、テスト対象コードが不足

## 提案内容

以下のテストファイルを追加し、カバレッジ70%以上を達成する。

### 追加するテストファイル

1. **HomeViewModelTest.kt**
   - 手動送信機能のテスト
   - 送信結果の状態管理テスト
   - エラーハンドリングテスト

2. **SettingsViewModelTest.kt**
   - Webhook URL保存のテスト
   - 設定値の読み込みテスト
   - バリデーションエラーのテスト

3. **GetTodayUsageUseCaseTest.kt**
   - 利用時間取得ロジックのテスト
   - 除外アプリフィルタリングのテスト
   - エッジケース（データなし、権限なし）のテスト

4. **UsageRepositoryTest.kt**
   - UsageStatsDataSourceとの連携テスト
   - データ変換ロジックのテスト

5. **SlackRepositoryTest.kt**
   - Webhook送信のテスト
   - ネットワークエラーハンドリングのテスト

6. **SlackMessageBuilderTest.kt**
   - メッセージフォーマットのテスト
   - 日本語表示のテスト

## 実装例

### HomeViewModelTest.kt

```kotlin
package jp.co.screentime.slackreporter.presentation.home

import app.cash.turbine.test
import io.mockk.*
import jp.co.screentime.slackreporter.domain.model.SendResult
import jp.co.screentime.slackreporter.domain.model.SendStatus
import jp.co.screentime.slackreporter.domain.usecase.SendDailyReportUseCase
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.ExperimentalCoroutinesApi
import kotlinx.coroutines.test.*
import org.junit.After
import org.junit.Assert.*
import org.junit.Before
import org.junit.Test

@OptIn(ExperimentalCoroutinesApi::class)
class HomeViewModelTest {
    
    private lateinit var viewModel: HomeViewModel
    private lateinit var sendDailyReportUseCase: SendDailyReportUseCase
    private val testDispatcher = StandardTestDispatcher()
    
    @Before
    fun setup() {
        Dispatchers.setMain(testDispatcher)
        sendDailyReportUseCase = mockk()
        viewModel = HomeViewModel(sendDailyReportUseCase)
    }
    
    @After
    fun tearDown() {
        Dispatchers.resetMain()
    }
    
    @Test
    fun `sendReport success updates state correctly`() = runTest {
        val successResult = SendResult(
            status = SendStatus.SUCCESS,
            lastSentEpochMillis = System.currentTimeMillis(),
            message = "送信成功"
        )
        coEvery { sendDailyReportUseCase() } returns successResult
        
        viewModel.uiState.test {
            val initialState = awaitItem()
            assertFalse(initialState.isSending)
            
            viewModel.sendReport()
            
            val sendingState = awaitItem()
            assertTrue(sendingState.isSending)
            
            val successState = awaitItem()
            assertFalse(successState.isSending)
            assertEquals(SendStatus.SUCCESS, successState.lastSendResult?.status)
        }
    }
    
    @Test
    fun `sendReport failure shows error message`() = runTest {
        val failureResult = SendResult(
            status = SendStatus.ERROR,
            lastSentEpochMillis = null,
            message = "送信失敗"
        )
        coEvery { sendDailyReportUseCase() } returns failureResult
        
        viewModel.sendReport()
        advanceUntilIdle()
        
        val state = viewModel.uiState.value
        assertFalse(state.isSending)
        assertEquals(SendStatus.ERROR, state.lastSendResult?.status)
        assertEquals("送信失敗", state.lastSendResult?.message)
    }
}
```

### GetTodayUsageUseCaseTest.kt

```kotlin
package jp.co.screentime.slackreporter.domain.usecase

import io.mockk.*
import jp.co.screentime.slackreporter.data.repository.UsageRepository
import jp.co.screentime.slackreporter.domain.model.AppUsage
import kotlinx.coroutines.test.runTest
import org.junit.Assert.*
import org.junit.Test

class GetTodayUsageUseCaseTest {
    
    @Test
    fun `returns usage data from repository`() = runTest {
        val repository = mockk<UsageRepository>()
        val mockUsage = listOf(
            AppUsage("com.youtube", 3600000L),
            AppUsage("com.chrome", 1800000L)
        )
        coEvery { repository.getTodayUsage() } returns mockUsage
        
        val useCase = GetTodayUsageUseCase(repository)
        val result = useCase()
        
        assertEquals(2, result.size)
        assertEquals("com.youtube", result[0].packageName)
        assertEquals(3600000L, result[0].durationMillis)
    }
    
    @Test
    fun `returns empty list when no usage data`() = runTest {
        val repository = mockk<UsageRepository>()
        coEvery { repository.getTodayUsage() } returns emptyList()
        
        val useCase = GetTodayUsageUseCase(repository)
        val result = useCase()
        
        assertTrue(result.isEmpty())
    }
    
    @Test
    fun `filters out zero duration apps`() = runTest {
        val repository = mockk<UsageRepository>()
        val mockUsage = listOf(
            AppUsage("com.youtube", 3600000L),
            AppUsage("com.system", 0L),
            AppUsage("com.chrome", 1800000L)
        )
        coEvery { repository.getTodayUsage() } returns mockUsage
        
        val useCase = GetTodayUsageUseCase(repository)
        val result = useCase()
        
        assertEquals(2, result.size)
        assertFalse(result.any { it.durationMillis == 0L })
    }
}
```

## 期待効果

- ✅ テストカバレッジ70%以上達成
- ✅ 主要ロジックの品質保証
- ✅ リファクタリング時の安全性向上
- ✅ リグレッション防止

## 検証方法

```bash
# テスト実行
./gradlew test

# カバレッジレポート生成
./gradlew jacocoTestReport

# レポート確認
open app/build/reports/jacoco/jacocoTestReport/html/index.html
```

**成功条件**: 
- 全テストがPASS
- カバレッジレポートで70%以上を確認

## 実装順序

1. HomeViewModelTest.kt を作成（最優先）
2. GetTodayUsageUseCaseTest.kt を作成
3. SettingsViewModelTest.kt を作成
4. SlackMessageBuilderTest.kt を作成
5. UsageRepositoryTest.kt を作成
6. SlackRepositoryTest.kt を作成
7. カバレッジ計測して70%達成を確認

## リスクと副作用

- **中リスク**: テスト作成に時間がかかる（推定: 4-6時間）
- **注意点**: モックの設定が複雑になる可能性（Hilt DIとの兼ね合い）

## ロールバック手順

```bash
# テストファイルを削除
git rm app/src/test/java/jp/co/screentime/slackreporter/presentation/home/HomeViewModelTest.kt
# ... 他のファイルも同様
git commit -m "Revert: テストファイル追加"
```

## 参考資料

- [Kotlin Coroutines Test](https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-test/)
- [MockK Documentation](https://mockk.io/)
- [Turbine - Flow Testing](https://github.com/cashapp/turbine)
